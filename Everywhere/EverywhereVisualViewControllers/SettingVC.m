//
//  SettingVC.m
//  Everywhere
//
//  Created by BobZhang on 16/7/13.
//  Copyright ¬© 2016Âπ¥ ZhangBaoGuo. All rights reserved.
//
#define DEBUGMODE 1

#import "SettingVC.h"
#import "UIView+AutoLayout.h"
#import "RETableViewManager.h"
#import "ShareImageVC.h"
#import "InAppPurchaseVC.h"
#import "AboutVC.h"

#import "EverywhereSettingManager.h"
#import "EverywhereShareRepositoryManager.h"
#import "WXApi.h"

#define NumberAndDecimal @"0123456789.\n"
#define Number @"0123456789\n"
#define kAlphaNum @"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789\n"
typedef BOOL (^OnChangeCharacterInRange)(RETextItem *item, NSRange range, NSString *replacementString);



const NSString *APP_DOWNLOAD_URL=@"https://itunes.apple.com/app/id1072387063";
const NSString *APP_INTRODUCTION_URL=@"http://7xpt9o.com1.z0.glb.clouddn.com/ChinaSceneryIntroduction.html";

@interface SettingVC ()<RETableViewManagerDelegate>

@property (strong,nonatomic) RETableViewManager *reTVManager;
@property (nonatomic,strong) UITableView *settingTableView;

@property (nonatomic,strong) EverywhereSettingManager *settingManager;

//@property (nonatomic,assign) int productIndex;

//@property (nonatomic,strong) NSString *shareTitle;
//@property (nonatomic,strong) NSString *shareDescription;
//@property (nonatomic,strong) NSString *shareWebpageUrl;
//@property (nonatomic,strong) NSData *shareThumbData;


@end

@implementation SettingVC

#pragma mark - Getter & Setter

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    
    self.view.backgroundColor = VCBackgroundColor;
    
    self.settingManager = [EverywhereSettingManager defaultManager];
    
    self.title = NSLocalizedString(@"Settings",@"ËÆæÁΩÆ");
    
    [self initSettingUI];
    
    self.navigationItem.leftBarButtonItem = [[UIBarButtonItem alloc] initWithBarButtonSystemItem:UIBarButtonSystemItemDone target:self action:@selector(backToMain)];
    
}

- (void)backToMain{
    [self.navigationController dismissViewControllerAnimated:YES completion:nil];
}

-(void)viewWillAppear:(BOOL)animated{
    [super viewWillAppear:animated];
    //[self initSettingUI];
}

-(void)initSettingUI{
    NSString *tempString;
    
    UITableView *settingTableView=[[UITableView alloc]initWithFrame:CGRectZero style:UITableViewStyleGrouped];
    settingTableView.translatesAutoresizingMaskIntoConstraints=NO;
    //settingTableView.delegate=self;
    //settingTableView.dataSource=self;
    
    [self.view addSubview:settingTableView];
    [settingTableView autoPinEdgesToSuperviewEdgesWithInsets:UIEdgeInsetsZero];
    
    self.settingTableView=settingTableView;
    
    //WeakSelf(weakSelf);
    
    self.reTVManager=[[RETableViewManager alloc]initWithTableView:self.settingTableView delegate:self];
    
#pragma mark ÂÖ®Â±ÄËÆæÁΩÆ
    
    RETableViewSection *section1=[RETableViewSection sectionWithHeaderTitle:NSLocalizedString(@"Globle", @"ÂÖ®Â±ÄËÆæÁΩÆ")];
    
#pragma mark ‰∏ªÈ¢òÈ¢úËâ≤
    
    NSArray *colorSchemeArray = @[NSLocalizedString(@"Classic Gray",@"ÁªèÂÖ∏ÁÅ∞"),NSLocalizedString(@"Fresh Purple",@"Ê∏ÖÊñ∞Á¥´"),NSLocalizedString(@"Deep Brown",@"Ê∑±Ê≤âÊ£ï")];
    NSString *currentCS = colorSchemeArray[self.settingManager.colorScheme < colorSchemeArray.count ? self.settingManager.colorScheme : colorSchemeArray.count - 1];
    REPickerItem *colorSchemePickerItem = [REPickerItem itemWithTitle:NSLocalizedString(@"Color Scheme",@"È¢úËâ≤ÊñπÊ°à")
                                                     value:@[currentCS]
                                               placeholder:nil
                                                   options:@[colorSchemeArray]];
    colorSchemePickerItem.onChange = ^(REPickerItem *item){
        ColorScheme newCS = [colorSchemeArray indexOfObject:item.value.firstObject];
        self.settingManager.colorScheme = newCS;
    };
    
    // Use inline picker in iOS 7
    //
    colorSchemePickerItem.inlinePicker = YES;
    
#pragma mark Êí≠ÊîæÊó∂Èó¥Èó¥Èöî
    
    tempString = [NSString stringWithFormat:@"%.f",self.settingManager.playTimeInterval];
    RETextItem *playTimeIntervalItem = [RETextItem itemWithTitle:NSLocalizedString(@"Play Time Interval",@"Êí≠ÊîæÊó∂Èó¥Èó¥Èöî") value:tempString placeholder:@""];
    playTimeIntervalItem.onChangeCharacterInRange = [self createLimitInputBlockWithAllowedString:NumberAndDecimal];
    playTimeIntervalItem.onEndEditing = ^(RETextItem *item){
        if(DEBUGMODE) NSLog(@"%@",item.value);
        self.settingManager.playTimeInterval = [item.value doubleValue];
    };

    [section1 addItemsFromArray:@[colorSchemePickerItem,playTimeIntervalItem]];
    
    
    
/*
    REBoolItem *useCellularDataItem=[REBoolItem itemWithTitle:NSLocalizedString(@"üåê ‰ΩøÁî®ËúÇÁ™ùÁßªÂä®Êï∞ÊçÆ", @"") value:YES switchValueChangeHandler:^(REBoolItem *item) {
        //[SceneryModel sharedModel].canUseCellularData=item.value;
    }];
    REBoolItem *catchHDItem=[REBoolItem itemWithTitle:NSLocalizedString(@"üåà ÁºìÂ≠òÈ´òÊ∏ÖÂõæ", @"") value:YES switchValueChangeHandler:^(REBoolItem *item) {
        
    }];
    RETableViewItem *clearCatchItem=[RETableViewItem itemWithTitle:NSLocalizedString(@"‚ùå Ê∏ÖÁêÜÁºìÂ≠ò",@"") accessoryType:UITableViewCellAccessoryNone selectionHandler:^(RETableViewItem *item) {
        [item deselectRowAnimated:YES];
        
    }];
*/
#pragma mark Êó∂ÂàªÊ®°Âºè
    RETableViewSection *mainModeSection=[RETableViewSection sectionWithHeaderTitle:NSLocalizedString(@"BaseMode", @"Âü∫Á°ÄÊ®°Âºè")];
    //Êó∂ÂàªÊ®°Âºè
    RETableViewSection *momentModeSection=[RETableViewSection sectionWithHeaderTitle:NSLocalizedString(@"MomentMode", @"Êó∂ÂàªÊ®°Âºè")];
    //[optionSection setHeaderHeight:30];
    
    tempString = [NSString stringWithFormat:@"%.f",self.settingManager.mergedDistanceForMoment];
    RETextItem *mergedDistanceForMomentItem = [RETextItem itemWithTitle:NSLocalizedString(@"Merged Distance",@"Êó∂ÂàªÊ®°ÂºèÂêàÂπ∂Ë∑ùÁ¶ª") value:tempString placeholder:@""];
    mergedDistanceForMomentItem.onChangeCharacterInRange = [self createLimitInputBlockWithAllowedString:NumberAndDecimal];
    mergedDistanceForMomentItem.onEndEditing = ^(RETextItem *item){
        if(DEBUGMODE) NSLog(@"%@",item.value);
        self.settingManager.mergedDistanceForMoment = [item.value doubleValue];
    };

    //mergedDistanceForMomentItem. = NSTextAlignmentRight;
    
    //[momentModeSection addItemsFromArray:@[mergedDistanceForMomentItem]];
    
#pragma mark Âú∞ÂùÄÊ®°Âºè
    
    //Âú∞ÂùÄÊ®°Âºè
    RETableViewSection *locationModeSection=[RETableViewSection sectionWithHeaderTitle:NSLocalizedString(@"LocationMode", @"Âú∞ÂùÄÊ®°Âºè")];
    //[optionSection setHeaderHeight:30];
    
    tempString = [NSString stringWithFormat:@"%.f",self.settingManager.mergedDistanceForLocation];
    RETextItem *mergedDistanceForLocationItem = [RETextItem itemWithTitle:NSLocalizedString(@"Merged Distance",@"Âú∞ÂùÄÊ®°ÂºèÂêàÂπ∂Ë∑ùÁ¶ª") value:tempString placeholder:@""];
    mergedDistanceForLocationItem.onChangeCharacterInRange = [self createLimitInputBlockWithAllowedString:NumberAndDecimal];
    mergedDistanceForLocationItem.onEndEditing = ^(RETextItem *item){
        if(DEBUGMODE) NSLog(@"%@",item.value);
        self.settingManager.mergedDistanceForLocation = [item.value doubleValue];
    };
    //mergedDistanceForLocationItem.textAlignment = NSTextAlignmentRight;
    //[locationModeSection addItemsFromArray:@[mergedDistanceForLocationItem]];
    
    [mainModeSection addItemsFromArray:@[mergedDistanceForMomentItem,mergedDistanceForLocationItem]];

#pragma mark ËÆ∞ÂΩïÊ®°Âºè
    
    RETableViewSection *extendedModeSection=[RETableViewSection sectionWithHeaderTitle:NSLocalizedString(@"RecordMode", @"ËÆ∞ÂΩïÊ®°Âºè")];
    //self.settingManager.shortestTimeIntervalForRecord
    
    tempString = [NSString stringWithFormat:@"%.f",self.settingManager.shortestDistanceForRecord];
    RETextItem *shortestDistanceForRecordItem = [RETextItem itemWithTitle:NSLocalizedString(@"Shortest Distance",@"ÊúÄÁü≠Ë∑ùÁ¶ª") value:tempString placeholder:@""];
    shortestDistanceForRecordItem.onChangeCharacterInRange = [self createLimitInputBlockWithAllowedString:NumberAndDecimal];
    shortestDistanceForRecordItem.onEndEditing = ^(RETextItem *item){
        if(DEBUGMODE) NSLog(@"%@",item.value);
        self.settingManager.shortestDistanceForRecord = [item.value doubleValue];
    };
    
    tempString = [NSString stringWithFormat:@"%.f",self.settingManager.shortestTimeIntervalForRecord];
    RETextItem *shortestTimeIntervalForRecordItem = [RETextItem itemWithTitle:NSLocalizedString(@"Shortest TimeInterval",@"ÊúÄÁü≠Êó∂Èó¥Èó¥Èöî") value:tempString placeholder:@""];
    shortestTimeIntervalForRecordItem.onChangeCharacterInRange = [self createLimitInputBlockWithAllowedString:NumberAndDecimal];
    shortestTimeIntervalForRecordItem.onEndEditing = ^(RETextItem *item){
        if(DEBUGMODE) NSLog(@"%@",item.value);
        self.settingManager.shortestTimeIntervalForRecord = [item.value doubleValue];
    };

    RETableViewItem *clearCatchItem=[RETableViewItem itemWithTitle:NSLocalizedString(@"‚ùå Ê∏ÖÁ©∫ÊâÄÊúâË∂≥Ëøπ",@"") accessoryType:UITableViewCellAccessoryNone selectionHandler:^(RETableViewItem *item) {
        [item deselectRowAnimated:YES];
        [EverywhereShareRepositoryManager setShareRepositoryArray:nil];
    }];
    [extendedModeSection addItemsFromArray:@[shortestDistanceForRecordItem,shortestTimeIntervalForRecordItem,clearCatchItem]];

    
#pragma mark Ë¥≠‰π∞
    
    RETableViewSection *purchaseSection=[RETableViewSection sectionWithHeaderTitle:NSLocalizedString(@"Purchase and Restore", @"Ë¥≠‰π∞‰∏éÊÅ¢Â§ç")];
    [purchaseSection setHeaderHeight:20];
    
    WEAKSELF(weakSelf);
    [purchaseSection addItem:[RETableViewItem itemWithTitle:NSLocalizedString(@"ShareFunctionAndBrowserMode",@"ÂàÜ‰∫´ÂäüËÉΩÂíåÊµèËßàÊ®°Âºè") accessoryType:UITableViewCellAccessoryDisclosureIndicator selectionHandler:^(RETableViewItem *item) {
        [item deselectRowAnimated:YES];
        [weakSelf showPurchaseShareFunctionAlertController];
    }]];
    
    [purchaseSection addItem:[RETableViewItem itemWithTitle:NSLocalizedString(@"RecordFuntionAndRecordMode",@"Ë∂≥ËøπËÆ∞ÂΩïÂíåËÆ∞ÂΩïÊ®°Âºè") accessoryType:UITableViewCellAccessoryDisclosureIndicator selectionHandler:^(RETableViewItem *item) {
        [item deselectRowAnimated:YES];
        [weakSelf showPurchaseRecordFunctionAlertController];
    }]];

#pragma mark ÂàÜ‰∫´
    RETableViewSection *shareSection=[RETableViewSection sectionWithHeaderTitle:NSLocalizedString(@"Share <AlbumMaps> to friends", @"ÂàÜ‰∫´„ÄäÁõ∏ÂÜåÂú∞Âõæ„ÄãÁªôÊúãÂèã")];
    [shareSection setHeaderHeight:20];
    [shareSection addItem:[RETableViewItem itemWithTitle:NSLocalizedString(@"üçÄ WeChat Timeline",@"üçÄ ÂæÆ‰ø°ÊúãÂèãÂúà") accessoryType:UITableViewCellAccessoryDisclosureIndicator selectionHandler:^(RETableViewItem *item) {
        [item deselectRowAnimated:YES];
        
        [self wxShare:WXSceneTimeline];
    }]];
    [shareSection addItem:[RETableViewItem itemWithTitle:NSLocalizedString(@"üí† WeChat Session",@"üí† ÂæÆ‰ø°Â•ΩÂèã") accessoryType:UITableViewCellAccessoryDisclosureIndicator selectionHandler:^(RETableViewItem *item) {
        [item deselectRowAnimated:YES];
        
        [self wxShare:WXSceneSession];
    }]];
    /*
     [shareSection addItem:[RETableViewItem itemWithTitle:NSLocalizedString(@"‚úâÔ∏è Áü≠‰ø°",@"") accessoryType:UITableViewCellAccessoryDisclosureIndicator selectionHandler:^(RETableViewItem *item) {
     [item deselectRowAnimated:YES];
     
     //[weakSelf sendSMS];
     }]];
     */
    
#pragma mark ÂÖ∂‰ªñ
    RETableViewSection *aboutSection=[RETableViewSection sectionWithHeaderTitle:NSLocalizedString(@"Others", @"")];
    [aboutSection setHeaderHeight:20];
    [aboutSection addItem:[RETableViewItem itemWithTitle:NSLocalizedString(@"üíñ Praise me!", @"üíñ Áªô‰∏™Â•ΩËØÑ") accessoryType:UITableViewCellAccessoryNone selectionHandler:^(RETableViewItem *item) {
        [item deselectRowAnimated:YES];
        [[UIApplication sharedApplication]openURL:[NSURL URLWithString:AppDownloadURLString]];
    }]];
    
    [aboutSection addItem:[RETableViewItem itemWithTitle:NSLocalizedString(@"üéâ About", @"üéâ ÂÖ≥‰∫é") accessoryType:UITableViewCellAccessoryDisclosureIndicator selectionHandler:^(RETableViewItem *item) {
        [item deselectRowAnimated:YES];
        AboutVC *aboutVC = [AboutVC new];
        aboutVC.edgesForExtendedLayout = UIRectEdgeNone;
        [self.navigationController pushViewController:aboutVC animated:YES];
    }]];
    
    [self.reTVManager addSectionsFromArray:@[section1,mainModeSection,extendedModeSection,purchaseSection,shareSection,aboutSection]];
}

#pragma mark - RE Block

-(OnChangeCharacterInRange)createLimitInputBlockWithAllowedString:(NSString *)string{
    OnChangeCharacterInRange block=^(RETextItem *item, NSRange range, NSString *replacementString){
        NSString *allowedString=string;
        NSCharacterSet *forbidenCharacterSet=[[NSCharacterSet characterSetWithCharactersInString:allowedString] invertedSet];
        NSArray *filteredArray=[replacementString componentsSeparatedByCharactersInSet:forbidenCharacterSet];
        NSString *filteredString=[filteredArray componentsJoinedByString:@""];
        
        if (![replacementString isEqualToString:filteredString]) {
            NSLog(@"The character „Äê%@„Äë is not allowed!",replacementString);
        }
        
        return [replacementString isEqualToString:filteredString];
    };
    
    return block;
}

#pragma mark - Simple WX Share

- (void)wxShare:(enum WXScene)wxScene{
    if (![WXApi isWXAppInstalled] || ![WXApi isWXAppSupportApi]){
        if(DEBUGMODE) NSLog(@"WeChat uninstalled or not support!");
        return;
    }
    
    WXWebpageObject *webpageObject=[WXWebpageObject new];
    webpageObject.webpageUrl = AppDownloadURLString;
    
    WXMediaMessage *mediaMessage=[WXMediaMessage alloc];
    // WXWebpageObject : ‰ºöËØùÊòæÁ§∫title„ÄÅdescription„ÄÅthumbDataÔºàÂõæÊ†áËæÉÂ∞è)ÔºåÊúãÂèãÂúàÊòæÁ§∫title„ÄÅthumbDataÔºàÂõæÊ†áËæÉÂ∞è),‰∏§ËÄÖÈÉΩÂèëÈÄÅwebpageUrl
    // WXImageObject   : ‰ºöËØùÂè™ÊòæÁ§∫thumbDataÔºàÂõæÊ†áËæÉÂ§ß)ÔºåÊúãÂèãÂúàÊòæÁ§∫ÂàÜ‰∫´ÁöÑÂõæÁâá,‰∏§ËÄÖÈÉΩÂèëÈÄÅimageData
    mediaMessage.title = NSLocalizedString(@"AlbumMaps‚Äî‚ÄîNice Album and Footprints Manager", @"Áõ∏ÂÜåÂú∞Âõæ‚Äî‚ÄîÊÇ®ÁöÑÁõ∏ÂÜåÂíåË∂≥ËøπÁÆ°ÁêÜ‰∏ìÂÆ∂");
    mediaMessage.description = NSLocalizedString(@"Record your life by albums.Measure the world by footprints.",@"Áî®Áõ∏ÂÜåËÆ∞ÂΩï‰∫∫ÁîüÔºåÁî®Ë∂≥Ëøπ‰∏àÈáè‰∏ñÁïå");
    mediaMessage.mediaObject = webpageObject;
    mediaMessage.thumbData = UIImageJPEGRepresentation([UIImage imageNamed:@"Âú∞ÁêÉ_300_300"], 0.5);
    
    SendMessageToWXReq *req=[SendMessageToWXReq new];
    req.message=mediaMessage;
    req.bText=NO;
    req.scene= wxScene;

    BOOL succeeded=[WXApi sendReq:req];
    if(DEBUGMODE) NSLog(@"SendMessageToWXReq : %@",succeeded? @"Succeeded" : @"Failed");
}

#pragma mark - copied From AssetsMapProVC

- (void)showPurchaseShareFunctionAlertController{
    NSString *alertTitle = NSLocalizedString(@"ShareFunctionAndBrowserMode",@"ÂàÜ‰∫´ÂäüËÉΩÂíåÊµèËßàÊ®°Âºè");
    NSString *alertMessage = [NSString stringWithFormat:@"%@\n%@\n%@\n%@\n%@",NSLocalizedString(@"You can get utilities below:", @"ÊÇ®Â∞ÜËé∑ÂæóÂ¶Ç‰∏ãÂäüËÉΩÔºö"),NSLocalizedString(@"1.Share your footprints to others", @"1.Â∞ÜË∂≥ËøπÂàÜ‰∫´Áªô‰ªñ‰∫∫"),NSLocalizedString(@"2.Store footprints both sended by you and shared by others", @"2.Â≠òÂÇ®Ë∂≥ËøπÔºåÂåÖÊã¨Ëá™Â∑±ÂèëÈÄÅÁöÑÂíåÂà´‰∫∫ÂàÜ‰∫´ÁöÑ"),NSLocalizedString(@"3.Unlock Browser Mode and  lookup stored footprints anytime", @"3.Ëß£ÈîÅÊµèËßàÊ®°ÂºèÔºåÈöèÊó∂Êü•ÁúãÂàÜ‰∫´Ë∂≥Ëøπ"),NSLocalizedString(@"Cost $1.99,continue?", @"‰ª∑Ê†º Ôø•12ÂÖÉÔºåÊòØÂê¶Ë¥≠‰π∞Ôºü")];
    
    [self showPurchaseAlertControllerWithTitle:alertTitle message:alertMessage productIndex:0];
}

- (void)showPurchaseRecordFunctionAlertController{
    NSString *alertTitle = NSLocalizedString(@"RecordFuntionAndRecordMode",@"Ë∂≥ËøπËÆ∞ÂΩïÂíåËÆ∞ÂΩïÊ®°Âºè");
    NSString *alertMessage = [NSString stringWithFormat:@"%@\n%@\n%@\n%@\n%@",NSLocalizedString(@"You can get utilities below:", @"ÊÇ®Â∞ÜËé∑ÂæóÂ¶Ç‰∏ãÂäüËÉΩÔºö"),NSLocalizedString(@"1.Record your footprints, support background recording", @"1.ËÆ∞ÂΩï‰Ω†ÁöÑËøêÂä®Ë∂≥Ëøπ"),NSLocalizedString(@"2.Intelligently edit your footprints", @"2.Ë∂≥ËøπÊô∫ËÉΩÁºñËæë"),NSLocalizedString(@"3.Unlock Record Mode to manage your recorded footprints", @"3.Ëß£ÈîÅËÆ∞ÂΩïÊ®°ÂºèÔºåÁÆ°ÁêÜ‰Ω†ËÆ∞ÂΩïÁöÑË∂≥Ëøπ"),NSLocalizedString(@"Cost $1.99,continue?", @"‰ª∑Ê†º Ôø•12ÂÖÉÔºåÊòØÂê¶Ë¥≠‰π∞Ôºü")];
    [self showPurchaseAlertControllerWithTitle:alertTitle message:alertMessage productIndex:1];
}

- (void)showPurchaseAlertControllerWithTitle:(NSString *)title message:(NSString *)message productIndex:(NSInteger)productIndex{
    UIAlertController *alertController = [UIAlertController alertControllerWithTitle:title message:message preferredStyle:UIAlertControllerStyleAlert];
    UIAlertAction *purchaseAction = [UIAlertAction actionWithTitle:NSLocalizedString(@"Purchase",@"Ë¥≠‰π∞")
                                                             style:UIAlertActionStyleDefault
                                                           handler:^(UIAlertAction * action) {
                                                               [self showPurchaseVC:productIndex transactionType:TransactionTypePurchase];
                                                           }];
    UIAlertAction *restoreAction = [UIAlertAction actionWithTitle:NSLocalizedString(@"Restore",@"ÊÅ¢Â§ç")
                                                            style:UIAlertActionStyleDefault
                                                          handler:^(UIAlertAction * action) {
                                                              [self showPurchaseVC:productIndex transactionType:TransactionTypeRestore];
                                                          }];
    UIAlertAction *cancelAction = [UIAlertAction actionWithTitle:NSLocalizedString(@"Cancel",@"ÂèñÊ∂à") style:UIAlertActionStyleCancel handler:nil];
    [alertController addAction:purchaseAction];
    [alertController addAction:restoreAction];
    [alertController addAction:cancelAction];
    
    [self presentViewController:alertController animated:YES completion:nil];
}

- (void)showInfomationAlertControllerWithTitle:(NSString *)title message:(NSString *)message{
    UIAlertController *alertController = [UIAlertController alertControllerWithTitle:title message:message preferredStyle:UIAlertControllerStyleAlert];
    UIAlertAction *okAction = [UIAlertAction actionWithTitle:NSLocalizedString(@"OK",@"Á°ÆÂÆö") style:UIAlertActionStyleDefault handler:nil];
    UIAlertAction *cancelAction = [UIAlertAction actionWithTitle:NSLocalizedString(@"Cancel",@"ÂèñÊ∂à") style:UIAlertActionStyleCancel handler:nil];
    [alertController addAction:okAction];
    [alertController addAction:cancelAction];
    [self presentViewController:alertController animated:YES completion:nil];
}

- (void)showPurchaseVC:(NSInteger)productIndex transactionType:(enum TransactionType)transactionType{
    InAppPurchaseVC *inAppPurchaseVC = [InAppPurchaseVC new];
    inAppPurchaseVC.edgesForExtendedLayout = UIRectEdgeNone;
    
    inAppPurchaseVC.productIDs = ProductIDs;
    inAppPurchaseVC.productIndex = productIndex;
    inAppPurchaseVC.transactionType = transactionType;
    
    WEAKSELF(weakSelf);
    inAppPurchaseVC.inAppPurchaseCompletionHandler = ^(BOOL success,NSInteger productIndex,enum TransactionType transactionType){
        NSString *typeString = transactionType == TransactionTypePurchase ? NSLocalizedString(@"Purchase", @"Ë¥≠‰π∞") : NSLocalizedString(@"Restore", @"ÊÅ¢Â§ç");
        NSString *resultString = nil;
        NSString *productNameString = productIndex == 0 ? NSLocalizedString(@"ShareFunctionAndBrowserMode",@"ÂàÜ‰∫´ÂäüËÉΩÂíåÊµèËßàÊ®°Âºè"): NSLocalizedString(@"RecordFuntionAndRecordMode",@"Ë∂≥ËøπËÆ∞ÂΩïÂíåËÆ∞ÂΩïÊ®°Âºè");
        
        if (success) {
            resultString = NSLocalizedString(@"Succeeded", @"ÊàêÂäü");
            if (productIndex == 0) self.settingManager.hasPurchasedShare = YES;
            if (productIndex == 1) self.settingManager.hasPurchasedRecord = YES;
        }else{
            resultString = NSLocalizedString(@"Failed", @"Â§±Ë¥•");
        }
        
        NSString *alertMessage = [NSString stringWithFormat:@"%@ %@ %@",typeString,productNameString,resultString];
        dispatch_sync(dispatch_get_main_queue(), ^{
            [weakSelf showInfomationAlertControllerWithTitle:NSLocalizedString(@"Purchase/Restore Result", @"Ë¥≠‰π∞/ÊÅ¢Â§çÁªìÊûú") message:alertMessage];
        });
    };
    
    UINavigationController *nav = [[UINavigationController alloc] initWithRootViewController:inAppPurchaseVC];
    [self presentViewController:nav animated:YES completion:nil];
}


@end
